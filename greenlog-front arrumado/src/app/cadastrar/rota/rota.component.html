<app-modal-bairros 
  [visivel]="modalBairrosVisivel"
  (fechado)="fecharModalBairros()"
  (bairroSelecionado)="onBairroSelecionado($event)">
</app-modal-bairros>

<app-modal-caminhao
  [visivel]="modalCaminhoesVisivel"
  (fechado)="fecharModalCaminhoes()"
  (caminhaoSelecionado)="onCaminhaoSelecionado($event)">
</app-modal-caminhao>

<div class="form-container">
  <header>
    <h2>{{ idEditando ? 'Editar' : 'Cadastro de' }} Rota</h2>
  </header>

  <form (ngSubmit)="salvar(formRota)" #formRota="ngForm">

    <!-- BotÃ£o de seleÃ§Ã£o de caminhÃ£o -->
    <div class="form-group">
      <label for="caminhao">CaminhÃ£o Selecionado:</label>
      <input
        type="text"
        id="caminhao"
        name="caminhao"
        readonly
        [value]="rotaAtual.caminhao?.placa || ''"
        placeholder="Clique para selecionar"
        (click)="abrirModalCaminhoes()"
        class="select-button"
        required
        [ngClass]="{ 'invalid-input': !rotaAtual.caminhao && formRota.submitted }"
      />
      <div *ngIf="!rotaAtual.caminhao && formRota.submitted" class="error-message">
        <small>Selecione um caminhÃ£o.</small>
      </div>
    </div>

    <!-- SeleÃ§Ã£o do tipo de resÃ­duo (limitado aos do caminhÃ£o) -->
    <div class="form-group" *ngIf="rotaAtual.caminhao">
      <label for="residuo">Tipo de ResÃ­duo (1 por rota):</label>
      <select
        id="residuo"
        name="residuo"
        required
        [(ngModel)]="rotaAtual.tipoResiduo"
        #residuoInput="ngModel"
        [ngClass]="{ 'invalid-input': residuoInput.invalid && (residuoInput.dirty || residuoInput.touched || formRota.submitted) }"
      >
        <option [ngValue]="null" disabled selected>Selecione</option>
        <option *ngFor="let tipo of rotaAtual.caminhao.residuos" [value]="tipo">{{ tipo }}</option>
      </select>
      <div *ngIf="residuoInput.invalid && (residuoInput.dirty || residuoInput.touched || formRota.submitted)" class="error-message">
        <small>Escolha um tipo de resÃ­duo.</small>
      </div>
    </div>

    <!-- BotÃ£o de seleÃ§Ã£o de bairro -->
    <div class="form-group">
      <label for="destino">Destino (Ponto de Coleta):</label>
      <input
        type="text"
        id="destino"
        name="destino"
        readonly
        [value]="rotaAtual.destino?.nome || ''"
        placeholder="Clique para selecionar"
        (click)="abrirModalBairros()"
        class="select-button"
        required
        [ngClass]="{ 'invalid-input': !rotaAtual.destino && formRota.submitted }"
      />
      <div *ngIf="!rotaAtual.destino && formRota.submitted" class="error-message">
        <small>Selecione o destino da rota.</small>
      </div>
    </div>

    <!-- BotÃ£o de cÃ¡lculo -->
    <div class="form-group">
      <button
        type="button"
        class="btn calcular"
        [disabled]="!rotaAtual.caminhao || !rotaAtual.tipoResiduo || !rotaAtual.destino"
      >
        ğŸš› Calcular Rota
      </button>
    </div>

    <!-- VisualizaÃ§Ã£o da rota -->
    <div *ngIf="rotaAtual.bairrosPercorridos.length > 0" class="resumo-rota">
      <h4>Resumo da Rota:</h4>
      <p><strong>Caminho:</strong> {{ rotaAtual.bairrosPercorridos.join(' â†’ ') }}</p>
      <p><strong>DistÃ¢ncia Total:</strong> {{ rotaAtual.distanciaTotal }} km</p>
      <p><strong>Tipo de ResÃ­duo:</strong> {{ rotaAtual.tipoResiduo }}</p>
    </div>

    <div *ngIf="mensagem?.tipo" [ngClass]="['popup', mensagem.tipo === 'erro' ? 'error' : 'success']">
    <span *ngIf="mensagem.tipo === 'salvo'">âœ…</span>
    <span *ngIf="mensagem.tipo === 'editado'">âœï¸</span>
    <span *ngIf="mensagem.tipo === 'excluido'">ğŸ—‘ï¸</span>
    <span *ngIf="mensagem.tipo === 'erro'">âŒ</span>
    {{ mensagem.texto }}
    </div>

    <!-- BotÃµes -->
    <div class="button-group">
      <button
        type="submit"
        class="btn salvar"
        [disabled]="formRota.invalid || rotaAtual.bairrosPercorridos.length === 0"
      >
        ğŸ’¾ {{ idEditando ? 'Atualizar' : 'Salvar' }}
      </button>
      <button type="button" class="btn cancelar" *ngIf="idEditando" (click)="resetForm()">âŒ Cancelar EdiÃ§Ã£o</button>
    </div>
  </form>
</div>

<header>
  <h3>Rota Cadastrados:</h3>
</header>

<table class="tabela-dados">
  <thead>
    <tr>
      <th>Caminhao</th>
      <th>Destino</th>
      <th>Tipo Residuos</th>
      <th>bairrosPercorridos</th>
      <th>distanciaTotal</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let rota of rotas">
      <td>{{ rota.caminhao?.placa}}</td>
      <td>{{ rota.destino?.nome}}</td>
      <td>{{ rota.tipoResiduo}}</td>
      <td>{{ rota.bairrosPercorridos}}</td>
      <td>{{ rota.distanciaTotal}}</td>
      <td>
        <button class="btn editar" (click)="editar(rota)">âœï¸ Editar</button>
        <button class="btn excluir" (click)="excluir(rota.id!)">ğŸ—‘ï¸ Excluir</button>
      </td>
    </tr>
    <tr *ngIf="rotas.length === 0">
      <td colspan="9" style="text-align: center;">Nenhum Ponto de Coleta cadastrado.</td>
    </tr>
  </tbody>
</table>
